<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Blockly for Hobbit</title>
    <meta name="description" content="Simplifying Hobbit">
    <meta name="author" content="Alexander Semeliker (TU Wien)">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="shortcut icon" href="img/favicon.ico" />
    <link rel="stylesheet" href="css/styles.css">
    <link type="text/css" rel="stylesheet" href="./css/materialize.min.css" media="screen,projection" />
</head>

<body onload="listDemos()">
    <div class="container">
        <div id="cont" class="row"></div>
    </div>

    <script src="./js/jquery.min.js"></script>
    <script type="text/javascript" src="./js/materialize.min.js"></script>
</body>

</html>
<script>
    function listDemos() {
        $("#cont").empty();
        $.post("/demolist",
            {
            }, function (data, status) {
                if (status == "success") {
                    for (var demofile of data.result) {
                        var title = demofile.slice(0, -4);

                        var demos = [
                            '<div class="col s6 m3">',
                            '<div class="card">',
                            '<div class="valign-wrapper demo">',
                            '<div class="card-content">',
                            '<div>' + title + '</div>',
                            '<div class="row center-align">',
                            '<a><div class="col s4 m4" onclick={deleteDemo(\'' + title + '\')}>delete</div></a>',
                            '<a><div class="col s4 m4" onclick={runDemo(\'' + title + '\')}>run</div></a>',
                            '<a><div class="col s4 m4" onclick={showDemo(\'' + demofile + '\')}>show</div></a>',
                            '</div>', '</div>', '</div>', '</div>', '</div>'
                        ].join("\n");

                        $("#cont").append(demos);
                    }
                    var createDemo = [
                        '<div class="col s6 m3">',
                        '<div class="card">',
                        '<div class="valign-wrapper call-blockly" onclick={loadBlockly()}>',
                        '<div class="card-content">',
                        '<div>Create</div>',
                        '</div>', '</div>', '</div>'
                    ].join("\n");

                    $("#cont").append(createDemo);
                } else {
                    alert("Something went wrong!");
                }
            });
    }

    function showDemo(demofile) {
        $.post("/load",
            {
                filename: demofile
            }, function (data, status) {
                if (status == "success") {
                    xml_demo = data.result;
                    localStorage.setItem("blocks_cache", xml_demo);
                    loadBlockly(true);
                } else {
                    alert("Something went wrong!");
                }
            });
    }

    function deleteDemo(demoname) {
        if (confirm("Do you really want to delete this demo?") == true)
            $.post("/delete",
                {
                    demoname: demoname
                }, function (data, status) {
                    if (status == "success") {
                        location.reload()
                        console.log("Demo \"" + demoname + "\" sucessfully deleted.");
                    } else {
                        alert("Something went wrong!");
                    }
                });
    }

    function runDemo(demofile) {
        if (confirm("Do you really want to run the demo?") == true) {
            console.log(demofile);
            $.post("/run",
                {
                    filename: "run.py",
                    sourcepath: "./demos/src/",
                    sourcefile: demofile + ".py"
                }, function (data, status) {
                    if (status == "success") {
                        alert(data.result);
                    } else {
                        alert("Something went wrong!");
                    }
                });
        }
    }

    function loadBlockly(keepStorage) {
        var url = window.location.href + 'blockly';
        if (!keepStorage) {
            localStorage.removeItem("blocks_cache");
            window.open(url,'_blank');
        } else {
            window.location.href = url;
        }
    }
</script>