<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Blocky for Hobbit</title>
    <meta name="description" content="Simplifying Hobbit">
    <meta name="author" content="Alexander Semeliker (TU Wien)">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="shortcut icon" href="img/favicon.ico" />

    <link rel="stylesheet" href="css/styles.css">
    <link type="text/css" rel="stylesheet" href="./css/materialize.min.css" media="screen,projection" />
    <link type="text/css" rel="stylesheet" href="./css/collapsible.css" media="screen,projection" />
</head>

<body>
    <div class="container">
        <div class="row btn-rule">
            <div style="float:left">
                <h4>Block Configuration</h4>
            </div>
            <div id="logo" onclick="toIndex()"></div>
        </div>
        <div class="row">
            <div class="col s2">
                <div id="blocks-overview">
                    <div class="row" style="margin-right: 0px;">
                        <div class="collection" style="margin-bottom: 15px !important;">
                            <a class="collection-item" id="createBlockNav" onclick="clearform()" style="font-weight: normal;">Create
                                new</a>
                        </div>
                        <div id="blockList" class="collection">
                        </div>
                    </div>
                </div>
            </div>
            <div class="col s10">
                <div id="blockMetas">
                    <div class="row">
                        <div class="input-field col s6">
                            <label for="title" class="active">Block title</label>
                            <input placeholder="Title" id="title" type="text" class="validate">
                        </div>
                        <div class="input-field col s6">
                            <label for="tooltip" class="active">Tooltip</label>
                            <input placeholder="Tooltip" id="tooltip" type="text" class="validate">
                        </div>
                        <div id="inputs" class="input-field col s6">
                            <label for="in1" class="active">Inputs
                                <button type="button" class="btn waves-effect waves-light toggle" onclick="addInput()">Add</button>
                                <button type="button" class="btn waves-effect waves-light toggle" onclick="removeInput()">Remove</button>
                            </label>
                            <input placeholder="Name" id="in1" type="text" class="validate">
                        </div>
                        <div class="input-field col s6">
                            <select id="typeSelector" style="display: block;border-bottom: 1px solid #8fbee5 !important;background-color: #f9f9f9;">
                                <option value="1">Topic</option>
                                <option value="2">Service</option>
                                <option value="3">Action</option>
                            </select>
                            <label class="active">Type</label>
                        </div>
                    </div>
                </div>
                <div id="configTopic">
                    <div class="row">
                        <div class="input-field col s6">
                            <label for="topic" class="active">Topic</label>
                            <input placeholder="Topic name" id="topic" type="text" class="validate">
                        </div>
                        <div class="input-field col s6">
                            <label for="msgtype" class="active">Message type</label>
                            <input placeholder="Message type" id="msgtype" type="text" class="validate">
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <label for="message" class="active">Message</label>
                            <textarea id="message" style="height:100px;" placeholder="message=..."></textarea>
                        </div>
                    </div>
                </div>
                <div id="configService">
                    <div class="row">
                        <div class="input-field col s6">
                            <label for="service" class="active">Service</label>
                            <input placeholder="Service name" id="service" type="text" class="validate">
                        </div>
                        <div class="input-field col s6">
                            <label for="srvtype" class="active">Message type</label>
                            <input placeholder="Message type" id="srvtype" type="text" class="validate">

                        </div>
                        <div id="requestFields" class="input-field col s12">
                            <label for="srvMsg1" class="active">Request message fields
                                <button type="button" class="btn waves-effect waves-light toggle" onclick="addSrvField()">Add</button>
                                <button type="button" class="btn waves-effect waves-light toggle" onclick="removeSrvField()">Remove</button>
                            </label>
                            <div id="srvMsg1">
                                <div class="blockly-collapsible">
                                    <input placeholder="Name" id="srvField1" type="text" class="validate srvField">
                                </div>
                                <div class="col-content">
                                    <textarea placeholder="enter value..." id="srvMsgVal1" style="height:50px; max-width: 100%; min-width: 100%;"></textarea>
                                    <label>
                                        <input id="srvCode1" type="checkbox" class="filled-in srvCode" />
                                        <span>Code</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="configAction">
                    Action
                </div>
                <div id="otherInfos">
                    <div class="row">
                        <div id="pyImports" class="blockly-collapsible col s12">
                            Import packages
                        </div>
                        <div class="col-content">
                            <textarea placeholder="import..." id="pckImports" style="height:50px; max-width: 100%; min-width: 100%;"></textarea>
                        </div>
                    </div>
                </div>
                <button id="saveBtn" class="btn waves-effect waves-light" type="submit" name="action" onclick="create()">Save</button>
                <button id="editBtn" class="btn waves-effect waves-light" type="submit" name="action" onclick="toggleEditMode(editMode)">Edit</button>
            </div>
        </div>
    </div>

    <script src="./js/jquery.min.js"></script>
    <script src="./js/collapsible.js"></script>

    <script>
        var selectedType = 'Topic';
        var inputCnt = 1;
        var srvFieldCnt = 1;
        init();
        document.getElementById('typeSelector').addEventListener('change', typeListener);
        typeListener();
        var editMode = false;

        function toggleEditMode(b) {
            var editBtn = document.getElementById("editBtn");
            editBtn.innerHTML = editMode ? "Edit" : "Cancel";

            // console.log(b,editMode);
            lockInputs(b);
            editMode = !b;
            // console.log(b,editMode);
        }

        function init() {
            $.get("/blocks", function (data, status) {
                if (status == "success") {

                    var selectedBlock = window.location.search.substring(1);

                    for (var block of data) {
                        var isSelectedBlock = block.name == selectedBlock;
                        var x = document.createElement("A");
                        x.setAttribute("href", "?" + block.name);
                        x.setAttribute("class", "collection-item");
                        x.setAttribute("style", "font-weight: normal;");
                        if (isSelectedBlock) x.setAttribute("class", "collection-item active");
                        x.innerHTML = block.meta.title;
                        document.getElementById("blockList").appendChild(x);

                        if (selectedBlock != "" && isSelectedBlock) {
                            setFormValues(block.meta);
                            if (block.meta.inputs) inputCnt = block.meta.inputs.length;
                            if (block.meta.fields) srvFieldCnt = block.meta.fields.length;
                        }
                    }

                    if (selectedBlock == "") {
                        var createBlockNav = document.getElementById("createBlockNav");
                        createBlockNav.setAttribute("class", "collection-item active");
                        var editBtn = document.getElementById("editBtn");
                        editBtn.setAttribute("style","display:none;");
                    } else {
                        lockInputs(true);
                    }

                } else {
                    alert("Something went wrong!");
                }
            });
        }

        function lockInputs(lock) {
            var shapes = ["title", "tooltip", "typeSelector", "topic", "service", "msgtype", "srvtype", "message", "pckImports"];
            var inputShapes = Array.from({ length: inputCnt }, (v, k) => "in" + (k + 1).toString());
            var srvFieldShapes = Array.from({ length: srvFieldCnt }, (v, k) => "srvField" + (k + 1).toString());
            var srvValShapes = Array.from({ length: srvFieldCnt }, (v, k) => "srvMsgVal" + (k + 1).toString());
            var srvCodeShapes = Array.from({ length: srvFieldCnt }, (v, k) => "srvCode" + (k + 1).toString());

            shapes = shapes.concat(inputShapes).concat(srvFieldShapes).concat(srvValShapes).concat(srvCodeShapes);

            for (var shape of shapes) {
                document.getElementById(shape).disabled = lock;
            }

            var toggleBtns = document.getElementsByClassName("toggle");
            for (var btn of toggleBtns) {
                btn.disabled = lock;
            }

            var saveBtn = document.getElementById("saveBtn");
            saveBtn.disabled = lock;
        }

        function setFormValues(values) {
            document.getElementById("title").value = values.title;
            document.getElementById("tooltip").value = values.tooltip;
            document.getElementById("typeSelector").selectedIndex = ["Topic", "Service", "Actions"].indexOf(values.type);

            if (values.pyImports) document.getElementById("pckImports").value = values.pyImports;

            typeListener();

            for (var i = 0; i < values.inputs.length; i++) {
                if (i == 0) {
                    document.getElementById("in" + (i + 1).toString()).value = values.inputs[i];
                } else {
                    addInput(values.inputs[i])
                }
            }

            if (values.type == "Topic") {
                document.getElementById("message").value = values.message;
                document.getElementById("topic").value = values.topic;
                document.getElementById("msgtype").value = values.msgtype;
            } else if (values.type == "Service") {
                document.getElementById("service").value = values.service;
                document.getElementById("srvtype").value = values.srvtype;

                for (var i = 0; i < values.fields.length; i++) {
                    if (i == 0) {
                        document.getElementById("srvField" + (i + 1).toString()).value = values.fields[i].name;
                        document.getElementById("srvMsgVal" + (i + 1).toString()).value = values.fields[i].value;
                        document.getElementById("srvCode" + (i + 1).toString()).checked = values.fields[i].isCode;
                    } else {
                        addSrvField(values.fields[i].name, values.fields[i].value, values.fields[i].isCode)
                    }
                }

            }
        }

        function toIndex() {
            window.location.href = window.location.origin;
        };

        function clearform() {
            window.location = window.location.origin + window.location.pathname;
        }

        function typeListener() {
            var typeSelector = document.getElementById("typeSelector");
            selectedType = typeSelector.options[typeSelector.selectedIndex].text;
            var elem = document.getElementById("config" + selectedType);
            elem.style.display = 'block';

            for (i = 0; i < typeSelector.length; i++) {
                if (i != typeSelector.selectedIndex) {
                    var t = typeSelector.options[i].text;
                    var elem = document.getElementById("config" + t);
                    elem.style.display = 'none';
                }
            }
        }

        function getBlockDefintion() {
            var title = document.getElementById("title").value + " %1";
            var inputs = document.getElementById("inputs").getElementsByTagName("INPUT");
            var tooltip = document.getElementById("tooltip").value;

            var block = {};
            block["args0"] = [{ type: "input_dummy" }];

            var inpMessages = [];

            var inCnt = 1;
            for (var inp of inputs) {
                inCnt += 1;
                inpMessages.push(inp.value + " %" + inCnt.toString());
                var tmpInp = { type: "input_value", align: "RIGHT", name: "var" + inCnt.toString() };
                block.args0.push(tmpInp);
            }

            block.message0 = [title, inpMessages.join(" ")].join(" ");
            block.previousStatement = null;
            block.nextStatement = null;
            block.colour = 50,
                block.tooltip = tooltip;
            block.helpUrl = "";

            return block
        }

        function getCodeTopic(block) {
            var topic = document.getElementById("topic").value;
            var msgtypeRaw = document.getElementById("msgtype").value;
            var message = document.getElementById("message").value;

            var msgPackage = msgtypeRaw.split("/")[0];
            var msgtype = msgtypeRaw.split("/")[1];

            var importCode = [importSyntax(msgPackage + ".msg", msgtype)];
            importCode = importCode.concat(importExtraPackages()).join("");

            var varInits = [];
            for (var inCnt = 2; inCnt <= block.args0.length; inCnt++) {
                varInits.push("var value_var" + inCnt.toString() + "=Blockly.Python.valueToCode(block,\'var" + inCnt.toString() + "\', Blockly.Python.ORDER_ATOMIC);");
            }
            varInits.push("Blockly.Python.InitROS();");


            var re = /\$([0-9]+)\$/gm;
            while ((match = re.exec(message)) != null) {
                if (inCnt < parseInt(match[1]) + 2) {
                    alert("Only " + (inCnt - 2).toString() + " inputs defined, but more used in message!")
                    return ""
                }
                message = message.replace(match[0], "'+value_var" + (parseInt(match[1]) + 1).toString() + "+'");
            }

            message = "var code='\\n';" + message.split("\n").map(e => "code+=\'" + e + "\\n\'").join(";");
            var MsgImport = "code+='HobbbitLib.importMsg(\\'" + msgPackage + ".msg\\',\\'" + msgtype + "\\')\\n'";
            var pubCode = "code+=Blockly.Python.NodeName+'.publishTopic(\\'" + topic + "\\', \\'" + msgtype + "\\', message)\\n';"
            var pyCode = [message, MsgImport, pubCode].join(";");

            return [varInits.join(""), importCode, pyCode, "return code"].join("")
        }

        function getMetaInfoTopic() {
            var inputs = [];
            var inputElems = document.getElementById("inputs").getElementsByTagName("INPUT");
            for (var inp of inputElems) {
                inputs.push(inp.value)
            }

            return {
                type: "Topic",
                topic: document.getElementById("topic").value,
                msgtype: document.getElementById("msgtype").value,
                message: document.getElementById("message").value,
                title: document.getElementById("title").value,
                inputs: inputs,
                pyImports: document.getElementById("pckImports").value,
                tooltip: document.getElementById("tooltip").value

            }
        }

        function getMetaInfoService() {
            var inputs = [];
            var inputElems = document.getElementById("inputs").getElementsByTagName("INPUT");
            for (var inp of inputElems) {
                inputs.push(inp.value)
            }

            return {
                type: "Service",
                service: document.getElementById("service").value,
                srvtype: document.getElementById("srvtype").value,
                title: document.getElementById("title").value,
                fields: formatSrvFields(),
                inputs: inputs,
                pyImports: document.getElementById("pckImports").value,
                tooltip: document.getElementById("tooltip").value

            }
        }

        function importSyntax(msgPackage, msgtype) {
            var imp = ["from", msgPackage, "import", msgtype];
            var importCode = "Blockly.Python.definitions_['" + imp.join("_") + "']='" + imp.join(" ") + "';";

            return importCode
        }

        function importExtraPackages() {
            var pyImports = document.getElementById("pckImports").value.split("\n");

            return pyImports.map(v => "Blockly.Python.definitions_['" + v.replace(/ /g, "_") + "']='" + v + "';")

        }

        function replaceDollars(message, inCnt) {
            var re = /\$([0-9]+)\$/gm;
            while ((match = re.exec(message)) != null) {
                if (inCnt < parseInt(match[1]) + 2) {
                    alert("Only " + (inCnt - 2).toString() + " inputs defined, but more used in message!")
                    return ""
                }
                message = message.replace(match[0], "'+value_var" + (parseInt(match[1]) + 1).toString() + "+'");
            }
            return message
        }

        function formatSrvFields() {
            var srvFields = document.getElementById("requestFields").getElementsByClassName("srvField");
            var srvChBoxes = document.getElementById("requestFields").getElementsByClassName("srvCode");
            var fieldValues = document.getElementById("requestFields").getElementsByTagName("TEXTAREA");

            var msgNames = Array.prototype.map.call(srvFields, elem => elem.value);
            var msgValues = Array.prototype.map.call(fieldValues, elem => elem.value);
            var codeFlags = Array.prototype.map.call(srvChBoxes, elem => elem.checked);

            var fields = [];
            for (i = 0; i < msgNames.length; i++) {
                let temp = {
                    name: msgNames[i],
                    value: msgValues[i],
                    isCode: codeFlags[i]
                };
                fields.push(temp);
            }

            return fields
        }

        function getCodeService(block) {
            var code = "";
            var service = document.getElementById("service").value;
            var srvtypeRaw = document.getElementById("srvtype").value;
            var srvFields = document.getElementById("requestFields").getElementsByClassName("srvField");
            var srvChBoxes = document.getElementById("requestFields").getElementsByClassName("srvCode");
            var fieldValues = document.getElementById("requestFields").getElementsByTagName("TEXTAREA");

            var msgPackage = srvtypeRaw.split("/")[0];
            var msgtype = srvtypeRaw.split("/")[1];

            var importCode = [importSyntax(msgPackage + ".srv", msgtype), importSyntax(msgPackage + ".srv", msgtype + "Request")];
            importCode = importCode.concat(importExtraPackages()).join("");


            var varInits = [];
            for (var inCnt = 2; inCnt <= block.args0.length; inCnt++) {
                varInits.push("var value_var" + inCnt.toString() + "=Blockly.Python.valueToCode(block,\'var" + inCnt.toString() + "\', Blockly.Python.ORDER_ATOMIC);");
            }
            varInits.push("Blockly.Python.InitROS();");

            var msgNames = Array.prototype.map.call(srvFields, elem => elem.value);
            var msgValues = Array.prototype.map.call(fieldValues, elem => elem.value);
            var codeFlags = Array.prototype.map.call(srvChBoxes, elem => elem.checked);

            var blocklyCode = [];

            for (i = 0; i < msgNames.length; i++) {
                var name = msgNames[i];
                var isCode = codeFlags[i];
                var value = replaceDollars(msgValues[i].replace(/\n/g, "\\n").replace(/\'/g, "\\'").replace(/\"/g, "\\'"), inCnt);
                if (value == "") return ""

                if (isCode) {
                    blocklyCode.push(value + "\\n");
                } else {
                    blocklyCode.push(name + "=" + value + "\\n");
                }

            }
            blocklyCode.push("reqparams=(" + msgNames.join(",") + ")\\n");

            var message = blocklyCode.map(v => "code+='" + v + "'").join(";");
            var MsgImport = "code+='HobbbitLib.importMsg(\\'" + msgPackage + ".srv\\',\\'" + msgtype + "\\')\\n'";
            var pubCode = "code+=Blockly.Python.NodeName+'.callService(\\'" + service + "\\', \\'" + msgtype + "\\', reqparams)\\n';"

            var pyCode = [message, MsgImport, pubCode].join(";");

            return [varInits.join(""), importCode, "var code='\\n';", pyCode, "return code"].join("")
        }

        function create() {
            var block = getBlockDefintion();

            if (selectedType == "Topic") {
                var code = getCodeTopic(block);
                var metaInfo = getMetaInfoTopic();
            } else if (selectedType == "Service") {
                var code = getCodeService(block);
                var metaInfo = getMetaInfoService();
            } else if (selectedType == "Action") {

            } else return

            if (code && code != "") {

                var newBlock = { "meta": JSON.stringify(metaInfo), "code": code, "block": JSON.stringify(block) };

                $.post("/create",
                    {
                        block: newBlock
                    }, function (data, status) {
                        if (status == "success") {
                            console.log("Block created");
                        } else {
                            alert("Something went wrong!");
                        }
                    });
            }
        }

        function addInput(value) {
            inputCnt += 1;
            var x = document.createElement("INPUT");
            x.setAttribute("placeholder", "Name");
            x.setAttribute("id", "in" + inputCnt);
            x.setAttribute("type", "text");
            x.setAttribute("class", "validate");
            if (value) x.setAttribute("value", value);
            document.getElementById("inputs").appendChild(x);
        }

        function removeInput(force) {
            var inputs = document.getElementById("inputs");
            if (inputCnt > 1 || force) {
                inputs.removeChild(inputs.childNodes[inputs.childNodes.length - 1]);
                inputCnt -= 1;
            };
        }

        function addSrvField(name, value, isCode) {
            srvFieldCnt += 1;

            var wrap = document.createElement("DIV");
            wrap.setAttribute("id", "srvMsg" + srvFieldCnt);

            var colps = document.createElement("DIV");
            colps.setAttribute("class", "blockly-collapsible");

            var inp = document.createElement("INPUT");
            inp.setAttribute("placeholder", "Name");
            inp.setAttribute("id", "srvField" + srvFieldCnt);
            inp.setAttribute("type", "text");
            inp.setAttribute("class", "validate srvField");
            if (name) inp.setAttribute("value", name);
            colps.appendChild(inp);

            var colCont = document.createElement("DIV");
            colCont.setAttribute("class", "col-content");

            var srvVal = document.createElement("TEXTAREA");
            srvVal.setAttribute("id", "srvMsgVal" + srvFieldCnt.toString());
            srvVal.setAttribute("placeholder", "Enter value...");
            srvVal.setAttribute("style", 'height:50px; max-width: 100%; min-width: 100%;');
            if (value) srvVal.value = value;

            var chBoxLbl = document.createElement("LABEL");
            var chBox = document.createElement("INPUT");
            chBox.setAttribute("id", "srvCode" + srvFieldCnt);
            chBox.setAttribute("type", "checkbox");
            chBox.setAttribute("class", "filled-in srvCode");
            if (isCode) chBox.checked = isCode;
            var chBoxDesc = document.createElement("SPAN");
            chBoxDesc.innerHTML = "Code";

            chBoxLbl.appendChild(chBox);
            chBoxLbl.appendChild(chBoxDesc);

            colCont.appendChild(srvVal);
            colCont.appendChild(chBoxLbl);

            wrap.appendChild(colps);
            wrap.appendChild(colCont);

            document.getElementById("requestFields").appendChild(wrap);
            updateListener()
        }

        function removeSrvField() {
            var fields = document.getElementById("requestFields");
            fields.removeChild(fields.childNodes[fields.childNodes.length - 1]);
        }

        function replaceInputs() {
        }


    </script>
</body>

</html>